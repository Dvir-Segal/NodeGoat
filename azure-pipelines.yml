trigger:
- master

pool:
  name: 'Default'

variables:
  imageName: 'nodegoat-app'

steps:
- task: SonarCloudPrepare@3
  displayName: 'Prepare SonarCloud'
  inputs:
    SonarCloud: 'SonarToken'
    organization: $(sonarOrganization)
    scannerMode: 'CLI'
    configMode: 'manual'
    cliProjectKey: $(sonarProjectKey)
    cliSources: '.'


- script: docker run --rm -v $(System.DefaultWorkingDirectory):/src aquasec/trivy fs --severity HIGH,CRITICAL --format table /src
  displayName: 'Trivy File System Scan'

- task: SonarCloudAnalyze@3
  displayName: 'Run SonarCloud Analysis'

- task: SonarCloudPublish@3
  displayName: 'Publish Sonar Results'
  inputs:
    pollingTimeoutSec: '300'

- task: Docker@2
  displayName: 'Build Docker Image'
  inputs:
    command: 'build'
    Dockerfile: '**/Dockerfile'
    repository: $(imageName)
    tags: |
      $(Build.BuildId)
      latest
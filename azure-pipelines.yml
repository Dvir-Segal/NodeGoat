trigger:
- master

pool:
  name: 'Default'

variables:
  imageName: 'nodegoat-app'

steps:
- script: docker run --rm -v $(System.DefaultWorkingDirectory):/src aquasec/trivy fs --severity HIGH,CRITICAL --format table /src
  displayName: 'Trivy File System Scan'

- task: Docker@2
  displayName: 'Build Docker Image'
  inputs:
    command: 'build'
    Dockerfile: '**/Dockerfile'
    repository: $(imageName)
    tags: |
      $(Build.BuildId)
      latest

- script: |
    docker save -o nodegoat-image.tar $(imageName):$(Build.BuildId)
  displayName: 'Save Docker Image for Scanning'

- script: |
    docker run --rm -v $(System.DefaultWorkingDirectory):/src aquasec/trivy image --input /src/nodegoat-image.tar --severity HIGH,CRITICAL
  displayName: 'Trivy Image Scan (via Tarball)'